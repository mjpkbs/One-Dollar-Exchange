<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ì°¨íŠ¸ ìƒì„±ê¸° (í™˜ìœ¨ & ì£¼ì‹)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            margin-bottom: 10px;
            color: #333;
            font-size: 24px;
        }

        .tab-buttons {
            display: flex;
            gap: 10px;
            margin-bottom: 30px;
            border-bottom: 2px solid #e0e0e0;
        }

        .tab-button {
            padding: 12px 24px;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            color: #666;
            border-bottom: 3px solid transparent;
            transition: all 0.3s;
        }

        .tab-button:hover {
            color: #333;
        }

        .tab-button.active {
            color: #0066cc;
            border-bottom-color: #0066cc;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input[type="text"] {
            width: 300px;
        }

        input[type="date"],
        input[type="time"] {
            width: 150px;
        }

        select {
            width: 200px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        button:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        button.primary {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
            font-weight: 600;
        }

        button.primary:hover {
            background: #0052a3;
            border-color: #0052a3;
        }

        button.success {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        button.success:hover {
            background: #218838;
            border-color: #218838;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        #chartContainer {
            margin-top: 30px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            background: white;
            overflow-x: auto;
        }

        #chart {
            min-width: 800px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-top: 10px;
        }

        .stock-suggestions {
            background: white;
            border: 1px solid #ddd;
            border-radius: 4px;
            max-height: 200px;
            overflow-y: auto;
            position: absolute;
            width: 300px;
            z-index: 1000;
            display: none;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        .stock-suggestion-item {
            padding: 10px;
            cursor: pointer;
            border-bottom: 1px solid #f0f0f0;
        }

        .stock-suggestion-item:hover {
            background: #f5f5f5;
        }

        .stock-suggestion-item .ticker {
            font-weight: 600;
            color: #0066cc;
        }

        .stock-suggestion-item .name {
            color: #666;
            font-size: 12px;
        }

        svg text {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“Š ì°¨íŠ¸ ìƒì„±ê¸°</h1>
        
        <div class="tab-buttons">
            <button class="tab-button active" onclick="switchTab('exchange')">ğŸ’± í™˜ìœ¨ ì°¨íŠ¸</button>
            <button class="tab-button" onclick="switchTab('stock')">ğŸ“ˆ ì£¼ì‹ ì°¨íŠ¸</button>
        </div>

        <!-- í™˜ìœ¨ íƒ­ -->
        <div id="exchangeTab" class="tab-content active">
            <div class="controls">
                <div class="control-group">
                    <label>ë°ì´í„° ì†ŒìŠ¤</label>
                    <select id="dataSource" onchange="toggleApiKeyField()">
                        <option value="yahoo">Yahoo Finance (ë¹ ë¥¸ ì‚¬ìš©, API í‚¤ ë¶ˆí•„ìš”)</option>
                        <option value="bok">í•œêµ­ì€í–‰ API (ê³µì‹ ë°ì´í„°, API í‚¤ í•„ìš”)</option>
                    </select>
                    <div class="info">âš ï¸ CORS í”„ë¡ì‹œ ì‚¬ìš©: ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì™¸ë¶€ í”„ë¡ì‹œë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.</div>
                </div>

                <div class="control-group" id="apiKeyGroup" style="display: none;">
                    <label>í•œêµ­ì€í–‰ API í‚¤</label>
                    <input type="text" id="apiKey" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                    <div class="info">API í‚¤: https://ecos.bok.or.kr/api/ ì—ì„œ ë°œê¸‰</div>
                </div>

                <div class="control-group">
                    <label>ë¹ ë¥¸ ì„ íƒ</label>
                    <div class="preset-buttons">
                        <button onclick="setPreset('intraday')">ğŸ“ˆ ì˜¤ëŠ˜ (1ë¶„)</button>
                        <button onclick="setPreset('today')">ì˜¤ëŠ˜</button>
                        <button onclick="setPreset('1week')">1ì£¼ì¼</button>
                        <button onclick="setPreset('1month')">1ê°œì›”</button>
                        <button onclick="setPreset('3months')">3ê°œì›”</button>
                        <button onclick="setPreset('6months')">6ê°œì›”</button>
                        <button onclick="setPreset('1year')">1ë…„</button>
                        <button onclick="setPreset('3years')">3ë…„</button>
                        <button onclick="setPreset('5years')">5ë…„</button>
                        <button onclick="setPreset('10years')">10ë…„</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>ê¸°ê°„ ì„¤ì •</label>
                    <div class="input-row">
                        <input type="date" id="startDate">
                        <span>~</span>
                        <input type="date" id="endDate">
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="primary" onclick="fetchAndDrawChart('exchange')">ê·¸ë˜í”„ ìƒì„±</button>
                    <button onclick="downloadSVG()">SVG ë‹¤ìš´ë¡œë“œ</button>
                    <button class="success" onclick="openInPhotopea()">Photopeaë¡œ ì—´ê¸° (PSD ë³€í™˜)</button>
                </div>
            </div>
        </div>

        <!-- ì£¼ì‹ íƒ­ -->
        <div id="stockTab" class="tab-content">
            <div class="controls">
                <div class="control-group">
                    <label>ì¢…ëª© ê²€ìƒ‰</label>
                    <div style="position: relative;">
                        <input type="text" id="stockSearch" placeholder="ì¢…ëª©ëª… ë˜ëŠ” í‹°ì»¤ ì…ë ¥ (ì˜ˆ: ì‚¼ì„±ì „ì, 005930)" 
                               oninput="searchStock()" onblur="setTimeout(() => hideSuggestions(), 200)">
                        <div id="stockSuggestions" class="stock-suggestions"></div>
                    </div>
                    <div class="info">ğŸ’¡ í•œêµ­ ì£¼ìš” ì¢…ëª©: ì‚¼ì„±ì „ì, SKí•˜ì´ë‹‰ìŠ¤, í˜„ëŒ€ì°¨, NAVER, ì¹´ì¹´ì˜¤ ë“±ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ í‹°ì»¤ ì½”ë“œë¥¼ ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”</div>
                </div>

                <div class="control-group">
                    <label>ì„ íƒëœ ì¢…ëª©</label>
                    <div class="input-row">
                        <input type="text" id="selectedStock" readonly placeholder="ì¢…ëª©ì„ ê²€ìƒ‰í•˜ì—¬ ì„ íƒí•˜ì„¸ìš”">
                        <input type="text" id="selectedTicker" readonly placeholder="í‹°ì»¤">
                    </div>
                </div>

                <div class="control-group">
                    <label>ë¹ ë¥¸ ì„ íƒ</label>
                    <div class="preset-buttons">
                        <button onclick="setStockPreset('1week')">1ì£¼ì¼</button>
                        <button onclick="setStockPreset('1month')">1ê°œì›”</button>
                        <button onclick="setStockPreset('3months')">3ê°œì›”</button>
                        <button onclick="setStockPreset('6months')">6ê°œì›”</button>
                        <button onclick="setStockPreset('1year')">1ë…„</button>
                        <button onclick="setStockPreset('3years')">3ë…„</button>
                        <button onclick="setStockPreset('5years')">5ë…„</button>
                        <button onclick="setStockPreset('max')">ì „ì²´</button>
                    </div>
                </div>

                <div class="control-group">
                    <label>ê¸°ê°„ ì„¤ì •</label>
                    <div class="input-row">
                        <input type="date" id="stockStartDate">
                        <span>~</span>
                        <input type="date" id="stockEndDate">
                    </div>
                </div>

                <div class="action-buttons">
                    <button class="primary" onclick="fetchAndDrawChart('stock')">ê·¸ë˜í”„ ìƒì„±</button>
                    <button onclick="downloadSVG()">SVG ë‹¤ìš´ë¡œë“œ</button>
                    <button class="success" onclick="openInPhotopea()">Photopeaë¡œ ì—´ê¸° (PSD ë³€í™˜)</button>
                </div>
            </div>
        </div>

        <div id="error"></div>
        <div id="chartContainer">
            <div class="loading">ì¢…ëª©ì„ ì„ íƒí•˜ê³  ê·¸ë˜í”„ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.</div>
        </div>
    </div>

    <script>
        // ì£¼ìš” í•œêµ­ ì£¼ì‹ ì¢…ëª© ë§¤í•‘
        const koreanStocks = [
            { name: 'ì‚¼ì„±ì „ì', ticker: '005930.KS', exchange: 'KRX' },
            { name: 'SKí•˜ì´ë‹‰ìŠ¤', ticker: '000660.KS', exchange: 'KRX' },
            { name: 'LGì—ë„ˆì§€ì†”ë£¨ì…˜', ticker: '373220.KS', exchange: 'KRX' },
            { name: 'ì‚¼ì„±ë°”ì´ì˜¤ë¡œì§ìŠ¤', ticker: '207940.KS', exchange: 'KRX' },
            { name: 'NAVER', ticker: '035420.KS', exchange: 'KRX' },
            { name: 'ì¹´ì¹´ì˜¤', ticker: '035720.KS', exchange: 'KRX' },
            { name: 'í˜„ëŒ€ì°¨', ticker: '005380.KS', exchange: 'KRX' },
            { name: 'ê¸°ì•„', ticker: '000270.KS', exchange: 'KRX' },
            { name: 'LGí™”í•™', ticker: '051910.KS', exchange: 'KRX' },
            { name: 'POSCOí™€ë”©ìŠ¤', ticker: '005490.KS', exchange: 'KRX' },
            { name: 'ì…€íŠ¸ë¦¬ì˜¨', ticker: '068270.KS', exchange: 'KRX' },
            { name: 'KBê¸ˆìœµ', ticker: '105560.KS', exchange: 'KRX' },
            { name: 'ì‹ í•œì§€ì£¼', ticker: '055550.KS', exchange: 'KRX' },
            { name: 'í•˜ë‚˜ê¸ˆìœµì§€ì£¼', ticker: '086790.KS', exchange: 'KRX' },
            { name: 'ì‚¼ì„±SDI', ticker: '006400.KS', exchange: 'KRX' },
            { name: 'í˜„ëŒ€ëª¨ë¹„ìŠ¤', ticker: '012330.KS', exchange: 'KRX' },
            { name: 'LGì „ì', ticker: '066570.KS', exchange: 'KRX' },
            { name: 'ì‚¼ì„±ë¬¼ì‚°', ticker: '028260.KS', exchange: 'KRX' },
            { name: 'SKì´ë…¸ë² ì´ì…˜', ticker: '096770.KS', exchange: 'KRX' },
            { name: 'SKí…”ë ˆì½¤', ticker: '017670.KS', exchange: 'KRX' },
            { name: 'KT&G', ticker: '033780.KS', exchange: 'KRX' },
            { name: 'ì¹´ì¹´ì˜¤ë±…í¬', ticker: '323410.KS', exchange: 'KRX' },
            { name: 'í¬ë˜í”„í†¤', ticker: '259960.KS', exchange: 'KRX' },
            { name: 'ì—”ì”¨ì†Œí”„íŠ¸', ticker: '036570.KS', exchange: 'KRX' },
            { name: 'ë„·ë§ˆë¸”', ticker: '251270.KS', exchange: 'KRX' },
        ];

        let currentSVG = null;
        let chartData = null;
        let currentChartType = 'exchange';
        let selectedStockData = null;

        // íƒ­ ì „í™˜
        function switchTab(tabName) {
            document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            if (tabName === 'exchange') {
                document.querySelector('.tab-button:nth-child(1)').classList.add('active');
                document.getElementById('exchangeTab').classList.add('active');
            } else {
                document.querySelector('.tab-button:nth-child(2)').classList.add('active');
                document.getElementById('stockTab').classList.add('active');
            }
        }

        // ì¢…ëª© ê²€ìƒ‰
        function searchStock() {
            const query = document.getElementById('stockSearch').value.toLowerCase().trim();
            const suggestionsDiv = document.getElementById('stockSuggestions');
            
            if (query.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            const filtered = koreanStocks.filter(stock => 
                stock.name.toLowerCase().includes(query) || 
                stock.ticker.toLowerCase().includes(query)
            );

            if (filtered.length === 0) {
                suggestionsDiv.style.display = 'none';
                return;
            }

            suggestionsDiv.innerHTML = filtered.map(stock => `
                <div class="stock-suggestion-item" onclick="selectStock('${stock.ticker}', '${stock.name}')">
                    <div class="ticker">${stock.ticker}</div>
                    <div class="name">${stock.name}</div>
                </div>
            `).join('');
            
            suggestionsDiv.style.display = 'block';
        }

        function selectStock(ticker, name) {
            document.getElementById('selectedStock').value = name;
            document.getElementById('selectedTicker').value = ticker;
            document.getElementById('stockSearch').value = name;
            selectedStockData = { ticker, name };
            hideSuggestions();
        }

        function hideSuggestions() {
            document.getElementById('stockSuggestions').style.display = 'none';
        }

        // ì£¼ì‹ ê¸°ê°„ í”„ë¦¬ì…‹
        function setStockPreset(preset) {
            const endDate = new Date();
            let startDate = new Date();

            switch(preset) {
                case '1week':
                    startDate.setDate(endDate.getDate() - 7);
                    break;
                case '1month':
                    startDate.setMonth(endDate.getMonth() - 1);
                    break;
                case '3months':
                    startDate.setMonth(endDate.getMonth() - 3);
                    break;
                case '6months':
                    startDate.setMonth(endDate.getMonth() - 6);
                    break;
                case '1year':
                    startDate.setFullYear(endDate.getFullYear() - 1);
                    break;
                case '3years':
                    startDate.setFullYear(endDate.getFullYear() - 3);
                    break;
                case '5years':
                    startDate.setFullYear(endDate.getFullYear() - 5);
                    break;
                case 'max':
                    startDate.setFullYear(endDate.getFullYear() - 20);
                    break;
            }

            document.getElementById('stockStartDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('stockEndDate').value = endDate.toISOString().split('T')[0];
        }

        // í™˜ìœ¨ ê¸°ê°„ í”„ë¦¬ì…‹
        function setPreset(preset) {
            const endDate = new Date();
            let startDate = new Date();

            if (preset === 'intraday') {
                document.getElementById('startDate').value = endDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
                return;
            }

            switch(preset) {
                case 'today':
                    startDate = endDate;
                    break;
                case '1week':
                    startDate.setDate(endDate.getDate() - 7);
                    break;
                case '1month':
                    startDate.setMonth(endDate.getMonth() - 1);
                    break;
                case '3months':
                    startDate.setMonth(endDate.getMonth() - 3);
                    break;
                case '6months':
                    startDate.setMonth(endDate.getMonth() - 6);
                    break;
                case '1year':
                    startDate.setFullYear(endDate.getFullYear() - 1);
                    break;
                case '3years':
                    startDate.setFullYear(endDate.getFullYear() - 3);
                    break;
                case '5years':
                    startDate.setFullYear(endDate.getFullYear() - 5);
                    break;
                case '10years':
                    startDate.setFullYear(endDate.getFullYear() - 10);
                    break;
            }

            document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
            document.getElementById('endDate').value = endDate.toISOString().split('T')[0];
        }

        function toggleApiKeyField() {
            const dataSource = document.getElementById('dataSource').value;
            const apiKeyGroup = document.getElementById('apiKeyGroup');
            apiKeyGroup.style.display = dataSource === 'bok' ? 'block' : 'none';
        }

        // Yahoo Financeì—ì„œ ì£¼ì‹ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchStockData() {
            if (!selectedStockData) {
                throw new Error('ì¢…ëª©ì„ ë¨¼ì € ì„ íƒí•´ì£¼ì„¸ìš”.');
            }

            const startDate = document.getElementById('stockStartDate').value;
            const endDate = document.getElementById('stockEndDate').value;

            if (!startDate || !endDate) {
                throw new Error('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }

            const period1 = Math.floor(new Date(startDate).getTime() / 1000);
            const period2 = Math.floor(new Date(endDate).getTime() / 1000);

            const url = `https://query1.finance.yahoo.com/v8/finance/chart/${selectedStockData.ticker}?period1=${period1}&period2=${period2}&interval=1d`;
            const proxyUrl = 'https://api.allorigins.win/raw?url=';

            const response = await fetch(proxyUrl + encodeURIComponent(url));
            if (!response.ok) {
                throw new Error('ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }

            const data = await response.json();
            
            if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                throw new Error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            const result = data.chart.result[0];
            const timestamps = result.timestamp;
            const quotes = result.indicators.quote[0];

            const points = timestamps.map((timestamp, i) => ({
                date: new Date(timestamp * 1000).toISOString().split('T')[0],
                value: quotes.close[i],
                high: quotes.high[i],
                low: quotes.low[i],
                open: quotes.open[i],
                volume: quotes.volume[i]
            })).filter(p => p.value != null);

            return points;
        }

        // Yahoo Financeì—ì„œ í™˜ìœ¨ ë°ì´í„° ê°€ì ¸ì˜¤ê¸°
        async function fetchYahooFinanceData() {
            const startDate = document.getElementById('startDate').value;
            const endDate = document.getElementById('endDate').value;

            if (!startDate || !endDate) {
                throw new Error('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }

            const isIntraday = startDate === endDate;

            if (isIntraday) {
                const url = 'https://query1.finance.yahoo.com/v8/finance/chart/KRW=X?interval=1m&range=1d';
                const proxyUrl = 'https://api.allorigins.win/raw?url=';

                const response = await fetch(proxyUrl + encodeURIComponent(url));
                if (!response.ok) {
                    throw new Error('Yahoo Finance API ìš”ì²­ ì‹¤íŒ¨');
                }

                const data = await response.json();
                
                if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                    throw new Error('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const result = data.chart.result[0];
                const timestamps = result.timestamp;
                const quotes = result.indicators.quote[0];

                const points = timestamps.map((timestamp, i) => ({
                    date: new Date(timestamp * 1000).toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit', hour12: false }),
                    value: quotes.close[i],
                    timestamp: timestamp
                })).filter(p => p.value != null);

                return points;
            } else {
                const period1 = Math.floor(new Date(startDate).getTime() / 1000);
                const period2 = Math.floor(new Date(endDate).getTime() / 1000);

                const url = `https://query1.finance.yahoo.com/v8/finance/chart/KRW=X?period1=${period1}&period2=${period2}&interval=1d`;
                const proxyUrl = 'https://api.allorigins.win/raw?url=';

                const response = await fetch(proxyUrl + encodeURIComponent(url));
                if (!response.ok) {
                    throw new Error('Yahoo Finance API ìš”ì²­ ì‹¤íŒ¨');
                }

                const data = await response.json();
                
                if (!data.chart || !data.chart.result || data.chart.result.length === 0) {
                    throw new Error('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                const result = data.chart.result[0];
                const timestamps = result.timestamp;
                const quotes = result.indicators.quote[0];

                const points = timestamps.map((timestamp, i) => ({
                    date: new Date(timestamp * 1000).toISOString().split('T')[0],
                    value: quotes.close[i],
                    timestamp: timestamp
                })).filter(p => p.value != null);

                return points;
            }
        }

        // í•œêµ­ì€í–‰ API
        async function fetchExchangeRateData() {
            const apiKey = document.getElementById('apiKey').value;
            if (!apiKey) {
                throw new Error('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }

            const startDate = document.getElementById('startDate').value.replace(/-/g, '');
            const endDate = document.getElementById('endDate').value.replace(/-/g, '');

            const url = `https://ecos.bok.or.kr/api/StatisticSearch/${apiKey}/json/kr/1/10000/036Y001/DD/${startDate}/${endDate}/0000001/?/?`;
            const proxyUrl = 'https://api.allorigins.win/raw?url=';

            const response = await fetch(proxyUrl + encodeURIComponent(url));
            if (!response.ok) {
                throw new Error('í•œêµ­ì€í–‰ API ìš”ì²­ ì‹¤íŒ¨');
            }

            const data = await response.json();
            
            if (!data.StatisticSearch || !data.StatisticSearch.row) {
                throw new Error('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. API í‚¤ì™€ ë‚ ì§œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }

            const points = data.StatisticSearch.row.map(item => ({
                date: item.TIME,
                value: parseFloat(item.DATA_VALUE)
            }));

            return points;
        }

        function formatDateDisplay(dateStr) {
            if (!dateStr) return '';
            
            if (dateStr.includes(':')) {
                return dateStr;
            }
            
            if (dateStr.length === 8) {
                return `${dateStr.substr(0,4)}.${dateStr.substr(4,2)}.${dateStr.substr(6,2)}`;
            }
            
            const date = new Date(dateStr);
            if (isNaN(date.getTime())) return dateStr;
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            
            return `${year}.${month}.${day}`;
        }

        function drawChart(points, chartType = 'exchange') {
            if (!points || points.length === 0) {
                throw new Error('ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
            }

            const width = 1200;
            const height = 600;
            const margin = { top: 80, right: 150, bottom: 80, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            const isIntradayMode = points[0].date && points[0].date.includes(':');

            const values = points.map(p => p.value);
            const yMin = Math.min(...values) * 0.995;
            const yMax = Math.max(...values) * 1.005;

            let svg = `<svg xmlns="http://www.w3.org/2000/svg" width="${width}" height="${height}" viewBox="0 0 ${width} ${height}">`;
            svg += `<rect width="${width}" height="${height}" fill="white"/>`;

            const startDateDisplay = isIntradayMode ? points[0].date : formatDateDisplay(points[0].date);
            const endDateDisplay = isIntradayMode ? points[points.length - 1].date : formatDateDisplay(points[points.length - 1].date);
            
            let titleText, subtitleText;
            if (chartType === 'stock') {
                titleText = `${selectedStockData.name} (${selectedStockData.ticker})`;
                subtitleText = `${startDateDisplay} ~ ${endDateDisplay}`;
            } else {
                titleText = isIntradayMode ? 'ë¯¸êµ­ ë‹¬ëŸ¬/ì› í™˜ìœ¨ (ì‹¤ì‹œê°„ - 1ë¶„)' : 'ë¯¸êµ­ ë‹¬ëŸ¬/ì› í™˜ìœ¨';
                subtitleText = isIntradayMode ? 
                    `ì˜¤ëŠ˜ ${startDateDisplay} ~ ${endDateDisplay}` : 
                    `${startDateDisplay} ~ ${endDateDisplay}`;
            }
            
            svg += `<text x="${width/2}" y="30" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="20" font-weight="bold" fill="#333">${titleText}</text>`;
            svg += `<text x="${width/2}" y="50" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="14" fill="#666">${subtitleText}</text>`;

            // ê·¸ë¦¬ë“œ ë° Yì¶• ë¼ë²¨
            const ySteps = 6;
            for (let i = 0; i <= ySteps; i++) {
                const value = yMin + (yMax - yMin) * i / ySteps;
                const y = margin.top + chartHeight - (chartHeight * i / ySteps);
                
                svg += `<line x1="${margin.left}" y1="${y}" x2="${width - margin.right}" y2="${y}" stroke="#e0e0e0" stroke-width="1"/>`;
                
                const labelValue = chartType === 'stock' ? 
                    value.toLocaleString('ko-KR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) :
                    Math.round(value);
                const suffix = chartType === 'stock' ? '' : '.00';
                svg += `<text x="${margin.left - 10}" y="${y + 5}" text-anchor="end" font-family="AppleSDGothicNeo-Regular" font-size="12" fill="#666">${labelValue}${suffix}</text>`;
            }

            // Xì¶• ë¼ë²¨
            let xLabelCount, xStep;
            
            if (isIntradayMode) {
                const firstTimestamp = points[0].timestamp;
                const lastTimestamp = points[points.length - 1].timestamp;
                const timeRange = lastTimestamp - firstTimestamp;
                
                const hourlyPoints = [];
                points.forEach((point, i) => {
                    if (point.date.endsWith(':00')) {
                        hourlyPoints.push({ 
                            timestamp: point.timestamp, 
                            label: point.date 
                        });
                    }
                });
                
                hourlyPoints.forEach(hp => {
                    const timeProgress = (hp.timestamp - firstTimestamp) / timeRange;
                    const x = margin.left + (chartWidth * timeProgress);
                    svg += `<text x="${x}" y="${height - margin.bottom + 20}" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="11" fill="#666">${hp.label}</text>`;
                    svg += `<line x1="${x}" y1="${height - margin.bottom}" x2="${x}" y2="${height - margin.bottom + 5}" stroke="#999" stroke-width="1"/>`;
                });
            } else {
                xLabelCount = Math.min(10, points.length);
                xStep = Math.floor(points.length / xLabelCount);
                
                for (let i = 0; i < points.length; i += xStep) {
                    const x = margin.left + (chartWidth * i / (points.length - 1));
                    const dateLabel = formatDateDisplay(points[i].date);
                    svg += `<text x="${x}" y="${height - margin.bottom + 20}" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="11" fill="#666">${dateLabel}</text>`;
                    svg += `<line x1="${x}" y1="${height - margin.bottom}" x2="${x}" y2="${height - margin.bottom + 5}" stroke="#999" stroke-width="1"/>`;
                }
            }

            // ì¶• ê·¸ë¦¬ê¸°
            svg += `<line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${height - margin.bottom}" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="${margin.left}" y1="${height - margin.bottom}" x2="${width - margin.right}" y2="${height - margin.bottom}" stroke="#333" stroke-width="2"/>`;

            // ë¼ì¸ ê²½ë¡œ ìƒì„±
            const firstTimestamp = points[0].timestamp || 0;
            const lastTimestamp = points[points.length - 1].timestamp || 1;
            const timeRange = lastTimestamp - firstTimestamp;
            
            let pathData = '';
            points.forEach((point, i) => {
                let x;
                if (isIntradayMode && timeRange > 0) {
                    const timeProgress = (point.timestamp - firstTimestamp) / timeRange;
                    x = margin.left + (chartWidth * timeProgress);
                } else {
                    x = margin.left + (chartWidth * i / (points.length - 1));
                }
                
                const y = margin.top + chartHeight - ((point.value - yMin) / (yMax - yMin) * chartHeight);
                
                if (i === 0) {
                    pathData += `M ${x} ${y}`;
                } else {
                    pathData += ` L ${x} ${y}`;
                }
            });

            // ìƒ‰ìƒ ì„¤ì • (ì£¼ì‹ì€ ë…¹ìƒ‰, í™˜ìœ¨ì€ íŒŒë€ìƒ‰)
            const lineColor = chartType === 'stock' ? '#10b981' : '#4285f4';
            
            // ì˜ì—­ ì±„ìš°ê¸° (ê·¸ë¼ë°ì´ì…˜)
            svg += `<defs>
                <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:${lineColor};stop-opacity:0.3" />
                    <stop offset="100%" style="stop-color:${lineColor};stop-opacity:0.05" />
                </linearGradient>
            </defs>`;

            const areaPath = pathData + ` L ${width - margin.right} ${height - margin.bottom} L ${margin.left} ${height - margin.bottom} Z`;
            svg += `<path d="${areaPath}" fill="url(#areaGradient)"/>`;

            // ë¼ì¸ ê·¸ë¦¬ê¸°
            svg += `<path d="${pathData}" fill="none" stroke="${lineColor}" stroke-width="3" stroke-linejoin="round" stroke-linecap="round"/>`;

            // ë°ì´í„° í¬ì¸íŠ¸
            if (!isIntradayMode) {
                points.forEach((point, i) => {
                    const x = margin.left + (chartWidth * i / (points.length - 1));
                    const y = margin.top + chartHeight - ((point.value - yMin) / (yMax - yMin) * chartHeight);
                    svg += `<circle cx="${x}" cy="${y}" r="4" fill="${lineColor}" stroke="white" stroke-width="2"/>`;
                });
            }

            // í˜„ì¬ê°’ í‘œì‹œ
            const lastPoint = points[points.length - 1];
            const lastX = margin.left + chartWidth;
            const lastY = margin.top + chartHeight - ((lastPoint.value - yMin) / (yMax - yMin) * chartHeight);
            
            const displayValue = chartType === 'stock' ? 
                lastPoint.value.toLocaleString('ko-KR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) :
                lastPoint.value.toFixed(2);
            const suffix = chartType === 'stock' ? 'ì›' : 'ì›';
            
            svg += `<rect x="${lastX + 10}" y="${lastY - 20}" width="100" height="40" fill="white" stroke="${lineColor}" stroke-width="2" rx="5"/>`;
            svg += `<text x="${lastX + 60}" y="${lastY}" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="16" font-weight="bold" fill="${lineColor}">${displayValue}${suffix}</text>`;

            // ë³€í™”ëŸ‰ ê³„ì‚°
            const firstValue = points[0].value;
            const change = lastPoint.value - firstValue;
            const changePercent = (change / firstValue * 100).toFixed(2);
            const changeColor = change >= 0 ? '#d32f2f' : '#1976d2';
            const changeSign = change >= 0 ? '+' : '';
            
            const changeDisplay = chartType === 'stock' ? 
                change.toLocaleString('ko-KR', {minimumFractionDigits: 0, maximumFractionDigits: 0}) :
                change.toFixed(2);
            
            svg += `<text x="${lastX + 60}" y="${lastY + 15}" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="12" fill="${changeColor}">${changeSign}${changeDisplay} (${changeSign}${changePercent}%)</text>`;

            svg += '</svg>';

            return svg;
        }

        // ë©”ì¸ í•¨ìˆ˜
        async function fetchAndDrawChart(type) {
            currentChartType = type;
            const errorDiv = document.getElementById('error');
            const chartContainer = document.getElementById('chartContainer');
            
            errorDiv.innerHTML = '';
            chartContainer.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                let data;
                
                if (type === 'stock') {
                    data = await fetchStockData();
                } else {
                    const dataSource = document.getElementById('dataSource').value;
                    if (dataSource === 'bok') {
                        data = await fetchExchangeRateData();
                    } else {
                        data = await fetchYahooFinanceData();
                    }
                }
                
                chartData = data;
                
                const svg = drawChart(data, type);
                currentSVG = svg;
                
                chartContainer.innerHTML = svg;
            } catch (error) {
                errorDiv.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
                chartContainer.innerHTML = '<div class="loading">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìœ„ì˜ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>';
                console.error('Error:', error);
            }
        }

        // SVG ë‹¤ìš´ë¡œë“œ
        function downloadSVG() {
            if (!currentSVG) {
                alert('ë¨¼ì € ê·¸ë˜í”„ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            const filename = currentChartType === 'stock' && selectedStockData ? 
                `ì£¼ì‹ì°¨íŠ¸_${selectedStockData.name}_${new Date().toISOString().split('T')[0]}.svg` :
                `í™˜ìœ¨ê·¸ë˜í”„_${new Date().toISOString().split('T')[0]}.svg`;

            const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Photopeaë¡œ ì—´ê¸°
        function openInPhotopea() {
            if (!currentSVG) {
                alert('ë¨¼ì € ê·¸ë˜í”„ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            const svgBase64 = btoa(unescape(encodeURIComponent(currentSVG)));
            
            const photopeaURL = `https://www.photopea.com#${encodeURIComponent(JSON.stringify({
                files: [`data:image/svg+xml;base64,${svgBase64}`],
                environment: {}
            }))}`;

            window.open(photopeaURL, '_blank');
            
            alert('Photopeaì—ì„œ íŒŒì¼ì´ ì—´ë¦½ë‹ˆë‹¤. í¸ì§‘ í›„ File > Export as > PSDë¥¼ ì„ íƒí•˜ì—¬ ì €ì¥í•˜ì„¸ìš”.');
        }

        // ì´ˆê¸° ë‚ ì§œ ì„¤ì •
        window.onload = function() {
            const today = new Date().toISOString().split('T')[0];
            const oneMonthAgo = new Date();
            oneMonthAgo.setMonth(oneMonthAgo.getMonth() - 1);
            
            document.getElementById('startDate').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('endDate').value = today;
            document.getElementById('stockStartDate').value = oneMonthAgo.toISOString().split('T')[0];
            document.getElementById('stockEndDate').value = today;
        };
    </script>
</body>
</html>
