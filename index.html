<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>í™˜ìœ¨ ê·¸ë˜í”„ ìƒì„±ê¸° (USD/KRW)</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
            padding: 20px;
            background: #f5f5f5;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            background: white;
            padding: 30px;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }

        h1 {
            margin-bottom: 30px;
            color: #333;
            font-size: 24px;
        }

        .controls {
            display: grid;
            gap: 20px;
            margin-bottom: 30px;
            padding: 20px;
            background: #f9f9f9;
            border-radius: 6px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        label {
            font-weight: 600;
            color: #555;
            font-size: 14px;
        }

        .input-row {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }

        input[type="text"],
        input[type="date"],
        input[type="time"],
        select {
            padding: 8px 12px;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 14px;
            font-family: inherit;
        }

        input[type="text"] {
            width: 300px;
        }

        input[type="date"],
        input[type="time"] {
            width: 150px;
        }

        select {
            width: 200px;
        }

        .preset-buttons {
            display: flex;
            gap: 8px;
            flex-wrap: wrap;
        }

        button {
            padding: 8px 16px;
            border: 1px solid #ddd;
            background: white;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            font-family: inherit;
            transition: all 0.2s;
        }

        button:hover {
            background: #f0f0f0;
            border-color: #999;
        }

        button.primary {
            background: #0066cc;
            color: white;
            border-color: #0066cc;
            font-weight: 600;
        }

        button.primary:hover {
            background: #0052a3;
            border-color: #0052a3;
        }

        button.success {
            background: #28a745;
            color: white;
            border-color: #28a745;
        }

        button.success:hover {
            background: #218838;
            border-color: #218838;
        }

        .action-buttons {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }

        #chartContainer {
            margin-top: 30px;
            border: 1px solid #ddd;
            border-radius: 6px;
            padding: 20px;
            background: white;
            overflow-x: auto;
        }

        #chart {
            min-width: 800px;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fee;
            border: 1px solid #fcc;
            color: #c00;
            padding: 15px;
            border-radius: 4px;
            margin-bottom: 20px;
        }

        .info {
            background: #e3f2fd;
            border: 1px solid #90caf9;
            color: #1565c0;
            padding: 12px;
            border-radius: 4px;
            font-size: 13px;
            margin-top: 10px;
        }

        svg text {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Malgun Gothic', sans-serif;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>ğŸ“ˆ í™˜ìœ¨ ê·¸ë˜í”„ ìƒì„±ê¸° (USD/KRW)</h1>

        <div class="controls">
            <div class="control-group">
                <label>ë°ì´í„° ì†ŒìŠ¤</label>
                <select id="dataSource" onchange="toggleApiKeyField()">
                    <option value="yahoo">Yahoo Finance (ë¹ ë¥¸ ì‚¬ìš©, API í‚¤ ë¶ˆí•„ìš”)</option>
                    <option value="bok">í•œêµ­ì€í–‰ API (ê³µì‹ ë°ì´í„°, API í‚¤ í•„ìš”)</option>
                </select>
                <div class="info">âš ï¸ CORS í”„ë¡ì‹œ ì‚¬ìš©: ë¸Œë¼ìš°ì € ë³´ì•ˆ ì •ì±…ìœ¼ë¡œ ì¸í•´ ì™¸ë¶€ í”„ë¡ì‹œë¥¼ í†µí•´ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤. ë” ì•ˆì •ì ì¸ ì‚¬ìš©ì„ ìœ„í•´ì„œëŠ” ì›¹ ì„œë²„ì— í˜¸ìŠ¤íŒ…í•˜ê±°ë‚˜ ë°±ì—”ë“œ ì„œë²„ë¥¼ êµ¬ì¶•í•˜ëŠ” ê²ƒì„ ê¶Œì¥í•©ë‹ˆë‹¤.</div>
            </div>

            <div class="control-group" id="apiKeyGroup" style="display: none;">
                <label>í•œêµ­ì€í–‰ API í‚¤</label>
                <input type="text" id="apiKey" placeholder="API í‚¤ë¥¼ ì…ë ¥í•˜ì„¸ìš”">
                <div class="info">API í‚¤: https://ecos.bok.or.kr/api/ ì—ì„œ ë°œê¸‰</div>
            </div>

            <div class="control-group">
                <label>ë¹ ë¥¸ ì„ íƒ</label>
                <div class="preset-buttons">
                    <button onclick="setPreset('intraday')">ğŸ“ˆ ì˜¤ëŠ˜ (1ë¶„)</button>
                    <button onclick="setPreset('today')">ì˜¤ëŠ˜</button>
                    <button onclick="setPreset('1week')">1ì£¼ì¼</button>
                    <button onclick="setPreset('1month')">1ê°œì›”</button>
                    <button onclick="setPreset('3months')">3ê°œì›”</button>
                    <button onclick="setPreset('6months')">6ê°œì›”</button>
                    <button onclick="setPreset('1year')">1ë…„</button>
                    <button onclick="setPreset('3years')">3ë…„</button>
                    <button onclick="setPreset('5years')">5ë…„</button>
                    <button onclick="setPreset('10years')">10ë…„</button>
                    <button onclick="setPreset('ytd')">ì˜¬í•´</button>
                </div>
                <div class="info" id="intradayInfo" style="display: none;">âš ï¸ 1ë¶„ ë°ì´í„°ëŠ” Yahoo Financeë§Œ ì§€ì›í•©ë‹ˆë‹¤ (ìµœê·¼ 7ì¼ ì´ë‚´, í‰ì¼ë§Œ)</div>
            </div>

            <div class="control-group">
                <label>ê¸°ê°„ ì„ íƒ</label>
                <div class="input-row">
                    <input type="date" id="startDate">
                    <span>~</span>
                    <input type="date" id="endDate">
                </div>
            </div>

            <div class="control-group" id="timeRangeGroup" style="display: none;">
                <label>ì‹œê°„ ë²”ìœ„ (1ë¶„ ë°ì´í„° ì „ìš©)</label>
                <div class="input-row">
                    <input type="time" id="startTime" value="00:00">
                    <span>~</span>
                    <input type="time" id="endTime" value="23:59">
                </div>
                <div class="info">ğŸ’¡ ìœ„ì˜ ê¸°ê°„ ì„ íƒì—ì„œ ì›í•˜ëŠ” ë‚ ì§œë¥¼ ì„ íƒí•˜ê³ , ì—¬ê¸°ì„œ ì‹œê°„ ë²”ìœ„ë¥¼ ì„¤ì •í•˜ì„¸ìš”. 1ì¼ ì´ë‚´ ë°ì´í„°ëŠ” ëª¨ë‘ 1ë¶„ ê°„ê²©ìœ¼ë¡œ í‘œì‹œë©ë‹ˆë‹¤.</div>
            </div>

            <div class="control-group" id="periodGroup" style="display: none;">
                <label>ë°ì´í„° ì£¼ê¸°</label>
                <select id="periodType">
                    <option value="D">ì¼ë³„ (Daily)</option>
                    <option value="M">ì›”ë³„ (Monthly)</option>
                    <option value="Y">ì—°ë³„ (Yearly)</option>
                </select>
            </div>

            <div class="action-buttons">
                <button class="primary" onclick="fetchAndDrawChart()">ğŸ“Š ê·¸ë˜í”„ ìƒì„±</button>
                <button class="success" onclick="downloadSVG()">ğŸ’¾ SVG ë‹¤ìš´ë¡œë“œ</button>
                <button class="success" onclick="openInPhotopea()">ğŸ¨ Photopeaë¡œ ì—´ê¸°</button>
            </div>
        </div>

        <div id="error"></div>
        <div id="chartContainer">
            <div class="loading">ê·¸ë˜í”„ë¥¼ ìƒì„±í•˜ë ¤ë©´ ìœ„ì˜ ì„¤ì •ì„ ì„ íƒí•˜ê³  "ê·¸ë˜í”„ ìƒì„±" ë²„íŠ¼ì„ í´ë¦­í•˜ì„¸ìš”.</div>
        </div>
    </div>

    <script>
        let chartData = null;
        let currentSVG = null;
        let isIntradayMode = false;  // 1ë¶„ ë°ì´í„° ëª¨ë“œ

        // API í‚¤ í•„ë“œ í‘œì‹œ/ìˆ¨ê¹€
        function toggleApiKeyField() {
            const dataSource = document.getElementById('dataSource').value;
            const apiKeyGroup = document.getElementById('apiKeyGroup');
            const periodGroup = document.getElementById('periodGroup');
            
            if (dataSource === 'bok') {
                apiKeyGroup.style.display = 'flex';
                periodGroup.style.display = 'flex';
            } else {
                apiKeyGroup.style.display = 'none';
                periodGroup.style.display = 'none';
            }
        }

        // ë‚ ì§œ í¬ë§· í•¨ìˆ˜
        function formatDate(date) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}${month}${day}`;
        }

        function formatDateDisplay(dateStr) {
            // YYYYMMDD -> YYYY-MM-DD
            if (dateStr.length === 8) {
                return `${dateStr.substr(0,4)}-${dateStr.substr(4,2)}-${dateStr.substr(6,2)}`;
            }
            // YYYYMM -> YYYY-MM
            if (dateStr.length === 6) {
                return `${dateStr.substr(0,4)}-${dateStr.substr(4,2)}`;
            }
            // YYYY -> YYYY
            return dateStr;
        }

        // í”„ë¦¬ì…‹ ë‚ ì§œ ì„¤ì •
        function setPreset(preset) {
            const today = new Date();
            const startDate = new Date();
            const intradayInfo = document.getElementById('intradayInfo');
            const timeRangeGroup = document.getElementById('timeRangeGroup');
            
            if (preset === 'intraday') {
                // 1ë¶„ ë°ì´í„°ëŠ” ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‚ ì§œ
                isIntradayMode = true;
                
                // Yahoo Financeë¡œ ê°•ì œ ì „í™˜
                document.getElementById('dataSource').value = 'yahoo';
                toggleApiKeyField();
                
                intradayInfo.style.display = 'block';
                timeRangeGroup.style.display = 'flex';
                
                // ê¸°ë³¸ ì‹œê°„ ì„¤ì • (ì „ì²´ í•˜ë£¨)
                document.getElementById('startTime').value = '00:00';
                document.getElementById('endTime').value = '23:59';
                
                // ë‚ ì§œëŠ” ì‚¬ìš©ìê°€ ì„ íƒí•˜ë„ë¡ í˜„ì¬ ë‚ ì§œ ìœ ì§€
                if (!document.getElementById('startDate').value) {
                    document.getElementById('startDate').value = today.toISOString().split('T')[0];
                }
                if (!document.getElementById('endDate').value) {
                    document.getElementById('endDate').value = today.toISOString().split('T')[0];
                }
            } else {
                isIntradayMode = false;
                intradayInfo.style.display = 'none';
                timeRangeGroup.style.display = 'none';
                
                switch(preset) {
                    case 'today':
                        startDate.setDate(today.getDate() - 1);
                        break;
                    case '1week':
                        startDate.setDate(today.getDate() - 7);
                        break;
                    case '1month':
                        startDate.setMonth(today.getMonth() - 1);
                        break;
                    case '3months':
                        startDate.setMonth(today.getMonth() - 3);
                        break;
                    case '6months':
                        startDate.setMonth(today.getMonth() - 6);
                        break;
                    case '1year':
                        startDate.setFullYear(today.getFullYear() - 1);
                        break;
                    case '3years':
                        startDate.setFullYear(today.getFullYear() - 3);
                        break;
                    case '5years':
                        startDate.setFullYear(today.getFullYear() - 5);
                        break;
                    case '10years':
                        startDate.setFullYear(today.getFullYear() - 10);
                        break;
                    case 'ytd':
                        startDate.setMonth(0);
                        startDate.setDate(1);
                        break;
                }
                
                document.getElementById('startDate').value = startDate.toISOString().split('T')[0];
                document.getElementById('endDate').value = today.toISOString().split('T')[0];
            }
        }

        // ì´ˆê¸° ë‚ ì§œ ì„¤ì • (ìµœê·¼ 1ê°œì›”)
        window.onload = function() {
            setPreset('1month');
        };

        // CORS í”„ë¡ì‹œ ëª©ë¡ (fallback ì§€ì›)
        const corsProxies = [
            'https://corsproxy.io/?',
            'https://api.allorigins.win/raw?url=',
            'https://cors-anywhere.herokuapp.com/'
        ];

        // CORS í”„ë¡ì‹œë¥¼ í†µí•´ fetch (ìë™ fallback)
        async function fetchWithCorsProxy(url) {
            let lastError;
            
            for (let i = 0; i < corsProxies.length; i++) {
                try {
                    const proxy = corsProxies[i];
                    const proxyUrl = proxy + encodeURIComponent(url);
                    console.log(`Trying CORS proxy ${i + 1}/${corsProxies.length}:`, proxy);
                    
                    const response = await fetch(proxyUrl);
                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }
                    return await response.json();
                } catch (error) {
                    console.warn(`CORS proxy ${i + 1} failed:`, error);
                    lastError = error;
                    // ë‹¤ìŒ í”„ë¡ì‹œ ì‹œë„
                }
            }
            
            throw new Error(`ëª¨ë“  CORS í”„ë¡ì‹œ ì‹¤íŒ¨: ${lastError.message}`);
        }

        // í•œêµ­ì€í–‰ APIì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (CORS ìš°íšŒ)
        async function fetchExchangeRateData() {
            const apiKey = document.getElementById('apiKey').value.trim();
            const startDate = document.getElementById('startDate').value.replace(/-/g, '');
            const endDate = document.getElementById('endDate').value.replace(/-/g, '');
            const periodType = document.getElementById('periodType').value;

            if (!apiKey) {
                throw new Error('API í‚¤ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }

            if (!startDate || !endDate) {
                throw new Error('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
            }

            // í•œêµ­ì€í–‰ API ì—”ë“œí¬ì¸íŠ¸
            // í†µê³„í‘œì½”ë“œ: 731Y001 (ì£¼ìš”êµ­ í™˜ìœ¨)
            // í†µê³„í•­ëª©ì½”ë“œ: 0000001 (ë¯¸êµ­ USD)
            const statCode = '731Y001';
            const itemCode = '0000001';
            
            const apiUrl = `https://ecos.bok.or.kr/api/StatisticSearch/${apiKey}/json/kr/1/10000/${statCode}/${periodType}/${startDate}/${endDate}/${itemCode}`;
            
            console.log('Fetching from:', apiUrl);

            const data = await fetchWithCorsProxy(apiUrl);

            console.log('API Response:', data);

            if (data.RESULT) {
                throw new Error(`API ì˜¤ë¥˜: ${data.RESULT.MESSAGE}`);
            }

            if (!data.StatisticSearch || !data.StatisticSearch.row) {
                throw new Error('ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‚ ì§œ ë²”ìœ„ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }

            return data.StatisticSearch.row;
        }

        // Yahoo Financeì—ì„œ ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ëŒ€ì²´ ë°©ë²•)
        // ì‹œê°„ ë²”ìœ„ì— ë”°ë¥¸ ì ì ˆí•œ ìƒ˜í”Œë§ ê°„ê²© ê²°ì •
        function getSamplingInterval(minutesRange) {
            // 1ì¼(1440ë¶„) ì´ë‚´ëŠ” ëª¨ë‘ 1ë¶„ ê°„ê²©
            if (minutesRange <= 1440) return 1;     // 24ì‹œê°„ ì´í•˜: 1ë¶„ë§ˆë‹¤
            // ì´í›„ëŠ” í•„ìš”ì‹œ ì¶”ê°€ ê°€ëŠ¥
            return 1;
        }

        // ë°ì´í„° ìƒ˜í”Œë§ (Në¶„ë§ˆë‹¤ í•œ ê°œì”©)
        function sampleData(data, intervalMinutes) {
            if (intervalMinutes === 1) return data; // 1ë¶„ì´ë©´ ìƒ˜í”Œë§ ë¶ˆí•„ìš”
            
            const sampled = [];
            for (let i = 0; i < data.length; i += intervalMinutes) {
                sampled.push(data[i]);
            }
            return sampled;
        }

        async function fetchYahooFinanceData() {
            let startDate = new Date(document.getElementById('startDate').value);
            let endDate = new Date(document.getElementById('endDate').value);
            
            let period1, period2;
            
            if (isIntradayMode) {
                // ì¸íŠ¸ë¼ë°ì´ ëª¨ë“œ: ì‹œê°„ ë²”ìœ„ ì ìš©
                const startTime = document.getElementById('startTime').value;
                const endTime = document.getElementById('endTime').value;
                
                const [startHour, startMinute] = startTime.split(':').map(Number);
                const [endHour, endMinute] = endTime.split(':').map(Number);
                
                // ì‹œì‘ ë‚ ì§œëŠ” ì‚¬ìš©ìê°€ ì„ íƒí•œ ë‚ ì§œ ì‚¬ìš©
                startDate.setHours(startHour, startMinute, 0, 0);
                
                // ì¢…ë£Œ ë‚ ì§œë„ ê°™ì€ ë‚ ì§œ ì‚¬ìš© (í•˜ë£¨ì¹˜ ë°ì´í„°)
                endDate = new Date(startDate);
                endDate.setHours(endHour, endMinute, 59, 999);
                
                // ì£¼ë§ ì²´í¬
                const dayOfWeek = startDate.getDay();
                if (dayOfWeek === 0 || dayOfWeek === 6) {
                    throw new Error('ì£¼ë§ì—ëŠ” ê±°ë˜ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. í‰ì¼ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
            }
            
            period1 = Math.floor(startDate.getTime() / 1000);
            period2 = Math.floor(endDate.getTime() / 1000);
            
            // ì¸íŠ¸ë¼ë°ì´ ëª¨ë“œì¸ ê²½ìš° 1ë¶„ ê°„ê²©, ì•„ë‹ˆë©´ 1ì¼ ê°„ê²©
            const interval = isIntradayMode ? '1m' : '1d';
            
            const apiUrl = `https://query1.finance.yahoo.com/v8/finance/chart/KRW=X?period1=${period1}&period2=${period2}&interval=${interval}`;
            
            console.log('Fetching from Yahoo Finance:', apiUrl, 'Intraday mode:', isIntradayMode);
            console.log('Date range:', startDate, 'to', endDate);
            
            const data = await fetchWithCorsProxy(apiUrl);
            
            console.log('Yahoo Finance Response:', data);
            
            if (!data.chart || !data.chart.result || !data.chart.result[0]) {
                throw new Error('Yahoo Financeì—ì„œ ë°ì´í„°ë¥¼ ê°€ì ¸ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
            }
            
            const result = data.chart.result[0];
            const timestamps = result.timestamp;
            const closes = result.indicators.quote[0].close;
            
            if (!timestamps || timestamps.length === 0) {
                if (isIntradayMode) {
                    throw new Error('ì„ íƒí•œ ë‚ ì§œì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ë§, ê³µíœ´ì¼ ë˜ëŠ” ìµœê·¼ 7ì¼ ì´ë‚´ì˜ í‰ì¼ ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                } else {
                    throw new Error('ì„ íƒí•œ ê¸°ê°„ì— ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ë‚ ì§œ ë²”ìœ„ë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                }
            }
            
            // í•œêµ­ì€í–‰ API í˜•ì‹ìœ¼ë¡œ ë³€í™˜
            let convertedData = timestamps.map((timestamp, i) => {
                const date = new Date(timestamp * 1000);
                let dateStr;
                
                if (isIntradayMode) {
                    // 1ë¶„ ë°ì´í„°ëŠ” ì‹œ:ë¶„ í˜•ì‹
                    const hours = String(date.getHours()).padStart(2, '0');
                    const minutes = String(date.getMinutes()).padStart(2, '0');
                    dateStr = `${hours}:${minutes}`;
                } else {
                    dateStr = formatDate(date);
                }
                
                return {
                    TIME: dateStr,
                    DATA_VALUE: closes[i] ? closes[i].toFixed(2) : null,
                    TIMESTAMP: timestamp,
                    DATE_OBJ: date
                };
            }).filter(d => d.DATA_VALUE !== null);
            
            // ì¸íŠ¸ë¼ë°ì´ ëª¨ë“œ: ì‚¬ìš©ìê°€ ì„ íƒí•œ ì‹œê°„ ë²”ìœ„ë¡œ í•„í„°ë§
            if (isIntradayMode) {
                convertedData = convertedData.filter(d => {
                    const timestamp = d.TIMESTAMP * 1000;
                    return timestamp >= startDate.getTime() && timestamp <= endDate.getTime();
                });
            }
            
            if (convertedData.length === 0) {
                if (isIntradayMode) {
                    throw new Error('ì„ íƒí•œ ë‚ ì§œ/ì‹œê°„ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. ì£¼ë§, ê³µíœ´ì¼ì´ ì•„ë‹Œ ìµœê·¼ 7ì¼ ì´ë‚´ì˜ ê±°ë˜ ì‹œê°„ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                } else {
                    throw new Error('ì„ íƒí•œ ê¸°ê°„ì— ìœ íš¨í•œ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.');
                }
            }
            
            // ì¸íŠ¸ë¼ë°ì´ ëª¨ë“œ: ì‹œê°„ ë²”ìœ„ì— ë”°ë¼ ìŠ¤ë§ˆíŠ¸ ìƒ˜í”Œë§
            if (isIntradayMode && convertedData.length > 0) {
                const minutesRange = (period2 - period1) / 60;
                const samplingInterval = getSamplingInterval(minutesRange);
                
                console.log(`Time range: ${minutesRange.toFixed(0)} minutes, Sampling every ${samplingInterval} minute(s)`);
                console.log(`Data points before sampling: ${convertedData.length}, after: ${Math.ceil(convertedData.length / samplingInterval)}`);
                
                convertedData = sampleData(convertedData, samplingInterval);
            }
            
            return convertedData;
        }

        // ê·¸ë˜í”„ ê·¸ë¦¬ê¸°
        function drawChart(data) {
            const width = 1200;
            const height = 600;
            const margin = { top: 60, right: 100, bottom: 80, left: 80 };
            const chartWidth = width - margin.left - margin.right;
            const chartHeight = height - margin.top - margin.bottom;

            // ë°ì´í„° ì²˜ë¦¬
            const points = data.map(d => ({
                date: d.TIME,
                value: parseFloat(d.DATA_VALUE),
                timestamp: d.TIMESTAMP
            })); // ë°ì´í„°ëŠ” ì´ë¯¸ ì‹œê°„ìˆœìœ¼ë¡œ ì •ë ¬ë˜ì–´ ìˆìŒ

            // ìµœì†Œ/ìµœëŒ€ê°’ ê³„ì‚°
            const values = points.map(p => p.value);
            const minValue = Math.min(...values);
            const maxValue = Math.max(...values);
            const valueRange = maxValue - minValue;
            
            // Yì¶•ì„ ê¹”ë”í•œ ì •ìˆ˜ë¡œ ë°˜ì˜¬ë¦¼
            const rawMin = minValue - valueRange * 0.1;
            const rawMax = maxValue + valueRange * 0.1;
            
            // ì ì ˆí•œ ê°„ê²© ê³„ì‚° (5, 10, 20 ë“±)
            const roughStep = (rawMax - rawMin) / 6;
            let niceStep;
            if (roughStep < 5) niceStep = 5;
            else if (roughStep < 10) niceStep = 10;
            else if (roughStep < 20) niceStep = 20;
            else if (roughStep < 50) niceStep = 50;
            else niceStep = Math.ceil(roughStep / 10) * 10;
            
            const yMin = Math.floor(rawMin / niceStep) * niceStep;
            const yMax = Math.ceil(rawMax / niceStep) * niceStep;

            // SVG ìƒì„±
            let svg = `<svg width="${width}" height="${height}" xmlns="http://www.w3.org/2000/svg">`;
            
            // ë°°ê²½
            svg += `<rect width="${width}" height="${height}" fill="white"/>`;

            // ì œëª©
            const startDateDisplay = isIntradayMode ? points[0].date : formatDateDisplay(points[0].date);
            const endDateDisplay = isIntradayMode ? points[points.length - 1].date : formatDateDisplay(points[points.length - 1].date);
            
            const titleText = isIntradayMode ? 'ë¯¸êµ­ ë‹¬ëŸ¬/ì› í™˜ìœ¨ (ì‹¤ì‹œê°„ - 1ë¶„)' : 'ë¯¸êµ­ ë‹¬ëŸ¬/ì› í™˜ìœ¨';
            const dateRangeText = isIntradayMode ? 
                `ì˜¤ëŠ˜ ${startDateDisplay} ~ ${endDateDisplay}` : 
                `${startDateDisplay} ~ ${endDateDisplay}`;
            
            svg += `<text x="${width/2}" y="30" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="20" font-weight="bold" fill="#333">${titleText}</text>`;
            svg += `<text x="${width/2}" y="50" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="14" fill="#666">${dateRangeText}</text>`;

            // ê·¸ë¦¬ë“œ ë° Yì¶• ë¼ë²¨
            const ySteps = 6;
            for (let i = 0; i <= ySteps; i++) {
                const value = yMin + (yMax - yMin) * i / ySteps;
                const y = margin.top + chartHeight - (chartHeight * i / ySteps);
                
                // ê·¸ë¦¬ë“œ ë¼ì¸
                svg += `<line x1="${margin.left}" y1="${y}" x2="${width - margin.right}" y2="${y}" stroke="#e0e0e0" stroke-width="1"/>`;
                
                // Yì¶• ë¼ë²¨ (ì •ìˆ˜.00 í˜•ì‹)
                const labelValue = Math.round(value);
                svg += `<text x="${margin.left - 10}" y="${y + 5}" text-anchor="end" font-family="AppleSDGothicNeo-Regular" font-size="12" fill="#666">${labelValue}.00</text>`;
            }

            // Xì¶• ë¼ë²¨
            let xLabelCount, xStep;
            
            if (isIntradayMode) {
                // 1ë¶„ ë°ì´í„°: ì •ê°(00ë¶„)ë§Œ í‘œì‹œ, ì‹œê°„ ê¸°ë°˜ ìœ„ì¹˜ ê³„ì‚°
                const firstTimestamp = points[0].timestamp;
                const lastTimestamp = points[points.length - 1].timestamp;
                const timeRange = lastTimestamp - firstTimestamp;
                
                const hourlyPoints = [];
                points.forEach((point, i) => {
                    // HH:MM í˜•ì‹ì—ì„œ ë¶„ì´ 00ì¸ ê²½ìš°ë§Œ ì„ íƒ
                    if (point.date.endsWith(':00')) {
                        hourlyPoints.push({ 
                            timestamp: point.timestamp, 
                            label: point.date 
                        });
                    }
                });
                
                // ì •ê° ë¼ë²¨ í‘œì‹œ (ì‹œê°„ ê¸°ë°˜ ìœ„ì¹˜)
                hourlyPoints.forEach(hp => {
                    const timeProgress = (hp.timestamp - firstTimestamp) / timeRange;
                    const x = margin.left + (chartWidth * timeProgress);
                    svg += `<text x="${x}" y="${height - margin.bottom + 20}" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="11" fill="#666">${hp.label}</text>`;
                    svg += `<line x1="${x}" y1="${height - margin.bottom}" x2="${x}" y2="${height - margin.bottom + 5}" stroke="#999" stroke-width="1"/>`;
                });
            } else {
                xLabelCount = Math.min(10, points.length);
                xStep = Math.floor(points.length / xLabelCount);
                
                for (let i = 0; i < points.length; i += xStep) {
                    const x = margin.left + (chartWidth * i / (points.length - 1));
                    const dateLabel = formatDateDisplay(points[i].date);
                    svg += `<text x="${x}" y="${height - margin.bottom + 20}" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="11" fill="#666">${dateLabel}</text>`;
                    
                    // Xì¶• ëˆˆê¸ˆ
                    svg += `<line x1="${x}" y1="${height - margin.bottom}" x2="${x}" y2="${height - margin.bottom + 5}" stroke="#999" stroke-width="1"/>`;
                }
            }

            // ì¶• ê·¸ë¦¬ê¸°
            svg += `<line x1="${margin.left}" y1="${margin.top}" x2="${margin.left}" y2="${height - margin.bottom}" stroke="#333" stroke-width="2"/>`;
            svg += `<line x1="${margin.left}" y1="${height - margin.bottom}" x2="${width - margin.right}" y2="${height - margin.bottom}" stroke="#333" stroke-width="2"/>`;

            // ë¼ì¸ ê²½ë¡œ ìƒì„±
            const firstTimestamp = points[0].timestamp;
            const lastTimestamp = points[points.length - 1].timestamp;
            const timeRange = lastTimestamp - firstTimestamp;
            
            let pathData = '';
            points.forEach((point, i) => {
                // ì¸íŠ¸ë¼ë°ì´ ëª¨ë“œ: ì‹œê°„ ê¸°ë°˜ X ìœ„ì¹˜, ê·¸ ì™¸: ì¸ë±ìŠ¤ ê¸°ë°˜
                let x;
                if (isIntradayMode && timeRange > 0) {
                    const timeProgress = (point.timestamp - firstTimestamp) / timeRange;
                    x = margin.left + (chartWidth * timeProgress);
                } else {
                    x = margin.left + (chartWidth * i / (points.length - 1));
                }
                
                const y = margin.top + chartHeight - ((point.value - yMin) / (yMax - yMin) * chartHeight);
                
                if (i === 0) {
                    pathData += `M ${x} ${y}`;
                } else {
                    pathData += ` L ${x} ${y}`;
                }
            });

            // ì˜ì—­ ì±„ìš°ê¸° (ê·¸ë¼ë°ì´ì…˜)
            svg += `<defs>
                <linearGradient id="areaGradient" x1="0%" y1="0%" x2="0%" y2="100%">
                    <stop offset="0%" style="stop-color:#4285f4;stop-opacity:0.3" />
                    <stop offset="100%" style="stop-color:#4285f4;stop-opacity:0.05" />
                </linearGradient>
            </defs>`;

            const areaPath = pathData + ` L ${width - margin.right} ${height - margin.bottom} L ${margin.left} ${height - margin.bottom} Z`;
            svg += `<path d="${areaPath}" fill="url(#areaGradient)"/>`;

            // ë¼ì¸ ê·¸ë¦¬ê¸°
            svg += `<path d="${pathData}" fill="none" stroke="#4285f4" stroke-width="3" stroke-linejoin="round" stroke-linecap="round"/>`;

            // ë°ì´í„° í¬ì¸íŠ¸ (1ë¶„ ë°ì´í„°ëŠ” ë„ˆë¬´ ë§ì•„ì„œ í‘œì‹œ ì•ˆ í•¨)
            if (!isIntradayMode) {
                points.forEach((point, i) => {
                    const x = margin.left + (chartWidth * i / (points.length - 1));
                    const y = margin.top + chartHeight - ((point.value - yMin) / (yMax - yMin) * chartHeight);
                    
                    svg += `<circle cx="${x}" cy="${y}" r="4" fill="#4285f4" stroke="white" stroke-width="2"/>`;
                });
            }

            // í˜„ì¬ê°’ í‘œì‹œ (ë§ˆì§€ë§‰ ë°ì´í„°)
            const lastPoint = points[points.length - 1];
            const lastX = margin.left + chartWidth;
            const lastY = margin.top + chartHeight - ((lastPoint.value - yMin) / (yMax - yMin) * chartHeight);
            
            svg += `<rect x="${lastX + 10}" y="${lastY - 20}" width="100" height="40" fill="white" stroke="#4285f4" stroke-width="2" rx="5"/>`;
            svg += `<text x="${lastX + 60}" y="${lastY}" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="16" font-weight="bold" fill="#4285f4">${lastPoint.value.toFixed(2)}ì›</text>`;

            // ë³€í™”ëŸ‰ ê³„ì‚°
            const firstValue = points[0].value;
            const change = lastPoint.value - firstValue;
            const changePercent = (change / firstValue * 100).toFixed(2);
            const changeColor = change >= 0 ? '#d32f2f' : '#1976d2';
            const changeSign = change >= 0 ? '+' : '';
            
            svg += `<text x="${lastX + 60}" y="${lastY + 15}" text-anchor="middle" font-family="AppleSDGothicNeo-Regular" font-size="12" fill="${changeColor}">${changeSign}${change.toFixed(2)} (${changeSign}${changePercent}%)</text>`;

            svg += '</svg>';

            return svg;
        }

        // ë©”ì¸ í•¨ìˆ˜
        async function fetchAndDrawChart() {
            const errorDiv = document.getElementById('error');
            const chartContainer = document.getElementById('chartContainer');
            const dataSource = document.getElementById('dataSource').value;
            
            errorDiv.innerHTML = '';
            chartContainer.innerHTML = '<div class="loading">ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...</div>';

            try {
                let data;
                
                if (dataSource === 'bok') {
                    data = await fetchExchangeRateData();
                } else {
                    data = await fetchYahooFinanceData();
                }
                
                chartData = data;
                
                const svg = drawChart(data);
                currentSVG = svg;
                
                chartContainer.innerHTML = svg;
            } catch (error) {
                errorDiv.innerHTML = `<div class="error">âŒ ${error.message}</div>`;
                chartContainer.innerHTML = '<div class="loading">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ìœ„ì˜ ì˜¤ë¥˜ ë©”ì‹œì§€ë¥¼ í™•ì¸í•˜ì„¸ìš”.</div>';
                console.error('Error:', error);
            }
        }

        // SVG ë‹¤ìš´ë¡œë“œ
        function downloadSVG() {
            if (!currentSVG) {
                alert('ë¨¼ì € ê·¸ë˜í”„ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            const blob = new Blob([currentSVG], { type: 'image/svg+xml' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `í™˜ìœ¨ê·¸ë˜í”„_${new Date().toISOString().split('T')[0]}.svg`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        // Photopeaë¡œ ì—´ê¸°
        function openInPhotopea() {
            if (!currentSVG) {
                alert('ë¨¼ì € ê·¸ë˜í”„ë¥¼ ìƒì„±í•´ì£¼ì„¸ìš”.');
                return;
            }

            // SVGë¥¼ base64ë¡œ ì¸ì½”ë”©
            const svgBase64 = btoa(unescape(encodeURIComponent(currentSVG)));
            
            // Photopea API ì‚¬ìš©
            const photopeaURL = `https://www.photopea.com#${encodeURIComponent(JSON.stringify({
                files: [`data:image/svg+xml;base64,${svgBase64}`],
                environment: {}
            }))}`;

            window.open(photopeaURL, '_blank');
            
            alert('Photopeaì—ì„œ íŒŒì¼ì´ ì—´ë¦½ë‹ˆë‹¤. í¸ì§‘ í›„ File > Export as > PSDë¥¼ ì„ íƒí•˜ì—¬ ì €ì¥í•˜ì„¸ìš”.');
        }
    </script>
</body>
</html>
